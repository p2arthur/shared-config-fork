name: On Merge to Main
author: p2arthur
description: CI, Docs, and Release workflow triggered on merges to main branch
on:
  workflow_call:
    inputs:
      project-type:
        description: Project type: node or python
        required: true
        type: string
      node-version:
        description: Node.js version (Node projects)
        required: false
        type: string
        default: 22
      python-version:
        description: Python version (Python projects)
        required: false
        type: string
        default: 3.12
      working-directory:
        description: Working directory (for monorepos)
        required: false
        type: string
        default: .
      skip-docs:
        description: Skip documentation build and publish
        required: false
        type: boolean
        default: false
    secrets:
      BOT_ID:
        required: true
      BOT_SK:
        required: true
      NPM_TOKEN:
        required: false
      PYPI_TOKEN:
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  pages: write

jobs:
  ci:
    name: CI
    uses: p2arthur/shared-config-fork/.github/workflows/ci.yml@main
    with:
      project-type: ${{ inputs.project-type }}
      working-directory: ${{ inputs.working-directory }}
      node-version: ${{ inputs.node-version }}
      python-version: ${{ inputs.python-version }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  docs:
    name: Docs
    needs: ci
    if: ${{ !inputs.skip-docs && needs.ci.result == 'success' }}
    uses: p2arthur/shared-config-fork/.github/workflows/docs.yml@main
    with:
      project-type: ${{ inputs.project-type }}
      working-directory: ${{ inputs.working-directory }}
      node-version: ${{ inputs.node-version }}
      python-version: ${{ inputs.python-version }}
      # Always publish to both targets (GitHub Pages + DevPortal)
      publish: true
      publish-devportal: true

  release:
    name: Release (Beta)
    needs: [ci, docs]
    if: |
      needs.ci.result == 'success' &&
      (needs.docs.result == 'success' || needs.docs.result == 'skipped')
    uses: p2arthur/shared-config-fork/.github/workflows/release.yml@main
    with:
      project-type: ${{ inputs.project-type }}
      working-directory: ${{ inputs.working-directory }}
      node-version: ${{ inputs.node-version }}
      python-version: ${{ inputs.python-version }}
      publish: true
      # No back-merge on main (beta releases stay on main)
    secrets:
      BOT_ID: ${{ secrets.BOT_ID }}
      BOT_SK: ${{ secrets.BOT_SK }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
