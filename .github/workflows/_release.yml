# ⚠️ INTERNAL: This workflow is NOT reusable
# It's specific to this repository for publishing the npm package
# For reusable workflows, see: ci.yml, pr.yml, release.yml, docs.yml

name: Internal Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry-run:
        description: Run in dry-run mode
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check-paths:
    name: Check Changed Paths
    runs-on: ubuntu-latest
    outputs:
      configs-changed: ${{ steps.filter.outputs.configs }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check for config changes
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            configs:
              - 'configs/**'
              - 'package.json'
              - 'scripts/build-dist.cjs'

  release:
    needs: check-paths
    uses: ./.github/workflows/release.yml
    with:
      back-merge: ${{ github.ref_name == 'release' }}
      config-path: .releaserc.json
      dry-run: ${{ inputs.dry-run || false }}
      publish: ${{ needs.check-paths.outputs.configs-changed == 'true' }}
      project-type: node
      use-oidc: true
    secrets:
      BOT_ID: ${{ secrets.BOT_ID }}
      BOT_SK: ${{ secrets.BOT_SK }}
